name: hadlink

services:
  # Fast, read-only redirect service (public-facing)
  redirect:
    image: hadlink:latest
    command: redirect
    ports:
      - "${REDIRECT_PORT:-8080}:8080"
    volumes:
      - hadlink-data:/data:ro
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    restart: unless-stopped
    environment:
      - HADLINK_STORAGE=/data/hadlink.db
      - HADLINK_MODE=redirect
      - HADLINK_PORT=8080
    networks:
      - public
      - internal
    mem_limit: 64m
    cpus: 0.2
    healthcheck:
      test: ["CMD-SHELL", "curl -s -o /dev/null http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on:
      shorten:
        condition: service_healthy

  # Slow, guarded creation service (private, LAN-only)
  # Note: Must be on 'public' network for port publishing to work with Docker.
  # The service itself does not make outbound connections.
  shorten:
    image: hadlink:latest
    entrypoint: ["/bin/sh", "-c"]
    command: ["export HADLINK_SECRET=$(cat /run/secrets/secret) && exec /usr/local/bin/hadlink shorten"]
    ports:
      - "127.0.0.1:${SHORTEN_PORT:-8443}:8443"
    volumes:
      - hadlink-data:/data:rw
    environment:
      - HADLINK_STORAGE=/data/hadlink.db
      - HADLINK_POW_DIFFICULTY=${POW_DIFFICULTY:-0}
      - HADLINK_POW_DIFFICULTY_AUTH=${POW_DIFFICULTY_AUTH:-0}
      - HADLINK_RATE_LIMIT=${RATE_LIMIT:-10}
      - HADLINK_MODE=shorten
      - HADLINK_PORT=8443
    secrets:
      - secret
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    restart: unless-stopped
    networks:
      - internal
      - public
    mem_limit: 128m
    healthcheck:
      test: ["CMD-SHELL", "curl -s -o /dev/null http://localhost:8443/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  # Public network for redirect service
  public:
    driver: bridge
  # Internal network for shorten service (not exposed)
  internal:
    driver: bridge
    internal: true

volumes:
  hadlink-data:

secrets:
  secret:
    file: ./secret.key
